<!doctype html>
<div id="topic" style="font-style: italic"></div>
<div id="chats"></div>
<script type="text/javascript">
function fetch(url, options) {
  // Somewhat pleasant wrapper around XHR.

  options = options || {};
  return new Promise(function(resolve, reject) {
    var xhr = new XMLHttpRequest();
    xhr.onload = function() {
      if (xhr.status >= 400) {
        reject(new Error('XHR returned status ' + xhr.status + ':\n' + xhr.responseText));
      } else {
        resolve(xhr);
      }
    };
    xhr.onerror = function(e) { reject(e); };
    if (options.hasOwnProperty('responseType'))
      xhr.responseType = options.responseType;
    var method = 'get';
    if (options.hasOwnProperty('method'))
      method = options.method;
    xhr.open(method, url);
    var data = undefined;
    if (options.hasOwnProperty('data'))
      data = options.data;
    xhr.send(data);
  });
}
function doGet(url) {
  return fetch(url);
}

function doPost(url, data) {
  return fetch(url, { method: 'post', data: data });
}

function doPut(url, data) {
  return fetch(url, { method: 'put', data: data });
}

function queryChats() {
  doGet('/chats').then(function(xhr) {
    document.querySelector('#chats').innerText = xhr.responseText;
    window.setTimeout(queryChats, 100);
  }, function(err) {
    console.error(err.stack);
    window.setTimeout(queryChats, 1000);
  });
}

function queryTopic()  {
  doGet('/topic').then(function(xhr) {
    document.querySelector('#topic').innerText = xhr.responseText;
    window.setTimeout(queryTopic, 1000);
  }, function(err) {
    console.error(err.stack);
    window.setTimeout(queryTopic, 10000);
  });
}

function sendChat() {
  doPost('/chats', document.querySelector('#chat').value)
      .catch(function (err) {
    console.error(err.stack);
  });
  document.querySelector('#chat').value = '';
}

function setTopic() {
  doPut('/topic', document.querySelector('#topic-new').value)
      .catch(function(err) {
    console.error(err.stack);
  });
  document.querySelector('#topic-new').value = '';
}
queryChats();
queryTopic();
</script>
<form action="#" onsubmit="sendChat(); return false">
<input type="text" name="chat" id="chat" autofocus>
<button>Chat</button>
</form>
<form action="#" onsubmit="setTopic(); return false">
<input type="text" name="topic-new" id="topic-new">
<button>Topic</button>
</form>
