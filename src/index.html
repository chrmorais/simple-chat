<!doctype html>
<style type="text/css">
body { margin: 0 8px }
#topic { font-style: italic }
#chats { height: 85%; overflow-y: scroll }
html, body { height: 100% }
</style>
<div id="topic"></div>
<div id="chats"></div>
<script type="text/javascript">
function fetch(url, options) {
  // Somewhat pleasant wrapper around XHR.

  options = options || {};
  return new Promise(function(resolve, reject) {
    var xhr = new XMLHttpRequest();
    xhr.onload = function() {
      if (xhr.status >= 400) {
        reject(new Error('XHR returned status ' + xhr.status + ':\n' + xhr.responseText));
      } else {
        resolve(xhr);
      }
    };
    xhr.onerror = function(e) { reject(e); };
    if (options.hasOwnProperty('responseType'))
      xhr.responseType = options.responseType;
    var method = 'get';
    if (options.hasOwnProperty('method'))
      method = options.method;
    xhr.open(method, url);
    var data = undefined;
    if (options.hasOwnProperty('data'))
      data = options.data;
    xhr.send(data);
  });
}
function doGet(url) {
  return fetch(url);
}

function doPost(url, data) {
  return fetch(url, { method: 'post', data: data });
}

function doPut(url, data) {
  return fetch(url, { method: 'put', data: data });
}

function handleError(cont) {
  return function(err) {
    console.error(err.stack);
    window.setTimeout(cont, 3000);
  };
}

function receiveXhr(cont, sel) {
  return function(xhr) {
    console.log("updating ", sel);
    var el = document.querySelector(sel);
    const doScroll = el.scrollTop == el.scrollHeight - el.offsetHeight;
    el.innerText = xhr.responseText;
    if (doScroll) {
      el.scrollTop = el.scrollHeight;
    }
    cont();
  };
}

function init() {
  doGet('/chats').then(receiveXhr(queryChats, '#chats'),
                       handleError(queryChats));
  doGet('/topic').then(receiveXhr(queryTopic, '#topic'),
                       handleError(queryTopic));
}

function queryChats() {
  doGet('/chats?new').then(receiveXhr(queryChats, '#chats'),
                           handleError(queryChats));
}

function queryTopic() {
  doGet('/topic?new').then(receiveXhr(queryTopic, '#topic'),
                           handleError(queryTopic));
}

function sendChat() {
  doPost('/chats', document.querySelector('#chat').value)
      .catch(function (err) {
    console.error(err.stack);
  });
  document.querySelector('#chat').value = '';
}

function setTopic() {
  doPut('/topic', document.querySelector('#topic-new').value)
      .catch(function(err) {
    console.error(err.stack);
  });
  document.querySelector('#topic-new').value = '';
}
init();
</script>
<form action="#" onsubmit="sendChat(); return false">
<input type="text" name="chat" id="chat" autofocus>
<button title="Send chat">&gt;</button>
</form>
<form action="#" onsubmit="setTopic(); return false">
<input type="text" name="topic-new" id="topic-new">
<button title="Set topic">^</button>
</form>
